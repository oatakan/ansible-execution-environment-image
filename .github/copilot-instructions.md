# Ansible Execution Environment Instructions

This repository defines Ansible Execution Environments (EE) built using `ansible-builder`.

## Project Structure & Architecture

- **Root Directories**: `ansible-base-ee-dev/` and `ansible-base-ee-main/` represent distinct execution environments.
- **Source of Truth**: `execution-environment.yml` in each directory is the primary configuration file.
- **Generated Artifacts**: The nested directories (e.g., `ansible-base-ee-dev/ansible-base-ee-dev/`) contain the `Containerfile`/`Dockerfile` and build context generated by `ansible-builder`. **Do not edit these manually.**

## Workflows

### Modifying Environments
To add dependencies or change build steps:
1. Edit the relevant `execution-environment.yml`.
   - **Galaxy Collections**: Add to `dependencies.galaxy.collections`.
   - **System Packages**: Add to `dependencies.system` (supports platform markers like `[platform:rpm]`).
   - **Python Packages**: Add to `dependencies.python`.
   - **Custom Build Steps**: Use `additional_build_steps` (`prepend_base`, `append_base`, `append_final`).

### Building Images
Run `ansible-builder` from the root to regenerate the context and build the image.

```bash
# Example for dev environment
ansible-builder build -v 3 --context=ansible-base-ee-dev --tag=ansible-base-ee-dev:latest
```

## Project Specifics

- **Dev Environment (`ansible-base-ee-dev`)**:
  - Base: `quay.io/centos/centos:stream9`
  - Customizations: Installs Python 3.12, `fuse-nfs` from source, `receptor`, and `helm`.
  - Note: Uses `dnf` and `alternatives` to manage Python versions.

- **Main Environment (`ansible-base-ee-main`)**:
  - Base: `quay.io/ansible/ansible-runner:latest`
  - Includes `chocolatey` via git dependency.

- **2.16 Environment (`ansible-base-ee-2.16`)**:
  - Base: `quay.io/centos/centos:stream9`
  - Purpose: Retains Ansible Core 2.16 for RHEL 8 / Python 3.6 managed node support.
  - Customizations: Similar to `dev` (Python 3.12 controller), but pins `ansible-core>=2.16,<2.17`.

## Common Patterns

- **Pinning Versions**: Dependencies in `execution-environment.yml` should generally be pinned for reproducibility.
- **Platform Markers**: Use `[platform:rpm]` or `[platform:rpm compile]` in `dependencies.system` to specify package manager behavior.
- **Git Dependencies**: Python and Galaxy dependencies can be installed directly from Git (e.g., `git+https://...`).
